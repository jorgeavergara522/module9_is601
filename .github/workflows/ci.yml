- name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt

- name: Wait for Postgres to be ready
  run: |
    for i in {1..30}; do
      docker run --rm --network=host postgres:15 \
        pg_isready -h localhost -p 5432 -U postgres -d fastapi_db && exit 0
      sleep 1
    done
    echo "Postgres not ready in time" && exit 1

- name: Initialize DB schema (create tables)
  env:
    DATABASE_URL: ${{ env.DATABASE_URL }}
  run: |
    python - <<'PY'
    from app.database.database import init_db
    init_db()
    print("DB initialized.")
    PY

- name: Run module 10 tests
  run: |
    pytest -q tests/test_security.py tests/test_schemas.py tests/test_user_endpoints.py -o addopts="" -p no:cov
- name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt

- name: Wait for Postgres to be ready
  run: |
    for i in {1..30}; do
      docker run --rm --network=host postgres:15 \
        pg_isready -h localhost -p 5432 -U postgres -d fastapi_db && exit 0
      sleep 1
    done
    echo "Postgres not ready in time" && exit 1

- name: Initialize DB schema (create tables)
  env:
    DATABASE_URL: ${{ env.DATABASE_URL }}
  run: |
    python - <<'PY'
    from app.database.database import init_db
    init_db()
    print("DB initialized.")
    PY

- name: Run module 10 tests
  run: |
    pytest -q tests/test_security.py tests/test_schemas.py tests/test_user_endpoints.py -o addopts="" -p no:cov
   
